// supabase/functions/analyze-pending-contents/prompts.ts

export function shouldSkipAnalysis(categoryCode: number | null): boolean {
  // 0: '其他', 1: '院會', 2: '委員會', 3: '黨團協商', 99: '索引', null: '未知'
  // 目前跳過 索引(99), 其他(0), 未知(null)
  return categoryCode === 99 || categoryCode === 0 || categoryCode === null;
}

// --- 主要分析 Prompt (整合了 Few-shot 範例以引導詳細內容風格) ---
export function getAnalysisPrompt(
  categoryCode: number | null,
  textContent: string,
  isTruncated: boolean
): string {
  let contextHint = ""; // 根據類別代碼提供上下文提示
  if (categoryCode === 1) contextHint = "此內容來自立法院院會記錄。";
  else if (categoryCode === 2) contextHint = "此內容來自立法院委員會記錄。";
  else if (categoryCode === 3) contextHint = "此內容來自立法院黨團協商記錄。";

  const truncationWarning = isTruncated // 如果內容被截斷，則添加警告
    ? "\n**重要提示：由於原始文本過長，以下提供的內容已被截斷。請基於現有內容進行分析，並盡可能提取核心資訊。**\n"
    : "";

  // --- Few-shot 範例 ---
  // 注意：這個範例的輸入文本是虛構的，主要目的是展示期望的 JSON 輸出風格和詳細程度。
  // 範例 JSON 輸出取自你提供的「喜歡的範例」中的第一個 agenda_item。
  const fewShotExample = `
**以下是一個分析範例，請學習其輸出的詳細程度和風格：**

**範例輸入文本（示意）：**
\`\`\`text
本日會議討論公務人員退休資遣撫卹法修正草案，多位委員針對所得替代率、退休金調整機制及危勞人員待遇提出不同看法。提案方強調信賴保護，主管機關則強調基金永續。最終主席裁示另定期審查並召開公聽會。
\`\`\`

**期望的範例 JSON 輸出 (詳細風格)：**
\`\`\`json
{
  "summary_title": "立法院司法及法制委員會審查公務人員退休資遣撫卹法與公務人員任用法修正草案",
  "overall_summary_sentence": "本次立法院司法及法制委員會會議主要併案審查多項旨在調整退休所得替代率、退休金調整機制及危勞人員待遇等的「公務人員退休資遣撫卹法」修正草案，以及涉及派用人員任職限制與增訂育孫留職停薪規定的「公務人員任用法」修正草案，會議中進行了提案說明、機關報告及朝野立委詢答；最終主席裁示相關草案均另定期繼續審查，並將召開公務人員退休資遣撫卹法相關修法公聽會。",
  "committee_name": "司法及法制委員會",
  "agenda_items": [
    {
      "item_title": "公務人員退休資遣撫卹法部分條文修正草案 (討論事項第 1 案)",
      "core_issue": [
        "停止退休所得替代率逐年調降：多項提案主張自 113 年或 114 年起，停止原定每年調降 1.5% 直至上限 60% (最低 30%) 的所得替代率規定。提案背景為認為年改已實施 6 年，近年物價上漲壓力大，且相較勞保獲撥補，持續調降對退休公務人員不公，應停止進一步削減以保障其基本生活與尊嚴。",
        "調整退休金與現職待遇連動：部分提案主張恢復退休金調整應與現職人員薪資調整掛鉤，認為現行與 CPI 連動機制不足以反映實際生活成本，且與現職脫鉤對退休人員不公平。",
        "降低 CPI 調整門檻：部分提案建議將觸發退休金調整的 CPI 累計成長率門檻由現行的 5% 降至 2% 或 3%，並可能縮短法定檢討週期（現為 4 年），以更即時反映物價波動。",
        "提高危勞人員待遇：部分提案針對警察、消防、海巡、空勤、移民等危勞職務人員，主張應比照國軍或單獨提高其所得替代率上限（例如有提案建議至 90%），以肯定其工作辛勞與風險。",
        "合併軍職年資計算：有提案建議，針對退除役官兵轉任公職者，其曾任軍職之年資應可合併計入公務人員退休年資審定，並據以計算退休所得替代率上限。",
        "信賴保護與世代公平爭議：提案方（多為國民黨委員）強調政府應遵守信賴保護原則，保障已退休人員的承諾與生活穩定；反對方（多為民進黨委員及主管機關）則強調年金改革是為確保基金永續與世代公平，避免未來基金破產導致現職與年輕世代無法領取退休金。"
      ],
      "key_speakers": [
        {
          "speaker_name": "賴士葆委員",
          "speaker_viewpoint": [
            "主要訴求：停止所得替代率逐年調降，讓退休軍公教警消有尊嚴。",
            "理由：批評年改是民進黨多數暴力下通過，追殺軍公教；相較之下，勞保未改且獲大量政府撥補（已 2,600 餘億，明年再加 1,300 億），極不公平。",
            "理由：認為退休人員生活因物價上漲已相當困難，年改實施 6 年已被砍 2,600 餘億，應適可而止。"
          ]
        },
        {
          "speaker_name": "翁曉玲委員",
          "speaker_viewpoint": "認為年改是錯誤政策，違反法律安定性與信賴保護原則，政府不應因財源不足任意削減退休金，此次修法是為恢復正義。"
        },
        {
          "speaker_name": "張嘉郡委員",
          "speaker_viewpoint": [
            "主要訴求：立即停止所得替代率逐年下降的設計。",
            "理由：年改違反信賴保護，國家背棄承諾，導致許多退休公務人員淪為均貧族，生活壓力大。",
            "說明：提案並非要推翻所有改革或走回頭路，而是將現況固定下來，避免進一步傷害。",
            "呼籲：賴總統應兌現過去曾表示年改方向可微調的承諾。"
          ]
        },
        {
          "speaker_name": "羅智強委員",
          "speaker_viewpoint": [
            "主要訴求：提高警消、海巡、空勤、移民署等危勞勤務人員的退休待遇。",
            "理由：抨擊政府對危勞人員口惠而實不至，其工作性質危險（如警消平均死亡年齡較國人低），應獲更好退休保障。",
            "批評年改：認為已砍 2,000 多億，應適可而止，質疑民進黨對勞保與公教的雙重標準。"
          ]
        },
        {
          "speaker_name": "施能傑部長 (銓敘部)",
          "speaker_viewpoint": [
            "反對停止調降替代率：將導致退撫基金提早 4-5 年（約 135 年）用罄，且預估未來 50 年將減少挹注約 2,800 億元，嚴重衝擊基金永續性與現職人員權益。",
            "說明現行制度合理性：因計算基礎（本俸 2 倍），實際替代率即使降至 60% 名目值，實質上仍約達 70%，高於 OECD 國家平均（約 53%）；且目前七成退休者平均實支月退俸已逾 5.1 萬元，高於民間平均薪資及勞保勞退合計金額。",
            "反對與現職待遇連動：國際慣例是與 CPI 連動，現行已有法定機制（CPI 達 5% 或至少每 4 年檢討），且已据此調整 6%；與現職連動不確定性高，且可能增加提早退休誘因，不利人力運用。",
            "反對降低 CPI 門檻：其他社會保險（如國保、勞保、公保）年金調整皆為 5%，應考量連動性；現有 4 年檢討機制已具備足夠彈性因應物價波動。",
            "反對提高危勞人員替代率：將違反基金參與者繳費與給付標準一致的核心原則，易引發其他人員比照要求；現行待遇（如危險加給、較高俸點）及退休制度（如較早退休年齡、較優撫卹）已對危勞人員有特別考量與優待。",
            "政府撥補責任：雖法律有最終支付責任規定，但前提是基金所有參與者應先共同努力維持基金財務健全與永續。",
            "建議：年改涉及層面廣泛且具高度社會關注，相關修法宜透過更廣泛的社會對話尋求共識後再行推動。"
          ]
        },
        {
          "speaker_name": "蘇俊榮人事長 (人事總處)",
          "speaker_viewpoint": [
            "強調年金永續與世代公平：認為修法應考量年金制度的永續性及世代公平問題。",
            "建議程序：年改涉及重大變革，期待能透過社會對話及公聽會方式凝聚共識後再審慎處理。",
            "說明調薪影響：近年現職人員已有調薪，雖所得替代率下降，但因計算母數增加，實際退休所得並非如名目替代率所示般降低。"
          ]
        },
        {
          "speaker_name": "鍾佳濱委員",
          "speaker_viewpoint": [
            "強調年改必要性與世代正義：引用過去資料與發言，指出基金瀕臨破產，改革是為年金永續，避免將負擔留給下一代。",
            "說明年改後狀況：退休人員實領金額因本俸調升及 CPI 調整機制，並未如預期般大幅減少，甚至可能增加；退休所得水平仍優於民間薪資及勞保勞退平均。",
            "擔憂走回頭路之後果：停止調降替代率將使基金提早用罄，損害仍在職及未來世代公務人員的權益，造成世代不公。",
            "呼籲保障現職人員：政府有限預算應優先用於提升現職人員（尤其是危勞辛苦人員）的待遇與福利，而非因停止年改而排擠現職資源。",
            "程序建議：年金改革屬重大議題，涉及多方利害關係人，應先召開公聽會以凝聚社會共識。"
          ]
        },
        {
          "speaker_name": "吳思瑤委員",
          "speaker_viewpoint": [
            "國際趨勢比較：指出世界各國因應高齡少子化，年改趨勢是越改越嚴，臺灣不應反其道而行、越改越寬鬆，走回頭路。",
            "強調社會溝通重要性：引用馬政府與蔡政府時期年改皆有大量座談或公聽會先例，主張本次修法爭議大，應先充分舉行公聽會再進行審查。",
            "質疑財政規劃矛盾：批評在野黨一方面推動財劃法修正可能掏空中央財源，另一方面卻又要求增加年金支出、加速撥補退撫基金，邏輯相互矛盾。",
            "釐清年改實際影響：說明年改節省經費主要來自 18% 優存利息的調整，實際影響退休金本金部分有限；現行退休所得替代率換算後仍高，且高於民間平均。",
            "程序建議：預算會期應以優先完成總預算審查為要務。"
          ]
        }
      ],
      "controversy": [
        "年金永續與世代公平 vs. 信賴保護與退休生活保障：支持修法方（多為國民黨委員）強調政府應遵守對退休人員的承諾（信賴保護），保障其在物價上漲下的基本生活；反對修法方（多為民進黨委員及主管機關）則強調年改是為確保基金永續，避免破產而損害現職與未來世代公務員的權益（世代公平），且大法官已肯認年改合憲性，符合公益考量。",
        "所得替代率調降的必要性與合理性爭議：支持停止調降方認為年改已實施 6 年，削減幅度已深（已降至 67.5%），對退休人員生活造成衝擊，應適可而止；反對方則指出停止調降將使基金提早 4-5 年用罄，嚴重影響財務永續，且現行計算方式下的實質替代率仍高於國際平均水平。",
        "退休金調整機制的最適模式：對於退休金應與 CPI 連動（現行制度）或與現職人員待遇連動，以及 CPI 觸發調整的門檻是否應由 5% 調降（如降至 2% 或 3%），存在不同主張與考量。",
        "與勞保政策的比較引發公平性質疑：提案方多次質疑政府對勞保持續進行大量財政撥補，卻對軍公教採取削減退休金的改革路徑，涉及差別待遇與公平性問題；主管機關則回應兩者基金性質與制度基礎不同，且年改節省經費已全數挹注退撫基金。",
        "危勞職務人員待遇是否應特別提高：部分提案主張應針對警察、消防等危勞人員，比照軍人或單獨提高其所得替代率上限；主管機關則認為現行待遇與退休制度已有特別考量與優待，再提高可能違反基金內部的公平原則，並引發其他職務比照要求。",
        "政府撥補責任與時程的爭議：對於政府在退撫基金中應扮演的角色、最終支付責任的詮釋，以及因應退撫新制（個人專戶制）所產生的財務缺口，應採取 10 年或 20 年撥補計畫，存在不同看法與角力。",
        "審查程序的爭議：會議中有大量程序發言與會議詢問，聚焦於如此重大的年金改革相關修法，是否應依照慣例先召開公聽會，廣納各界意見、凝聚社會共識後，再進入實質審查階段。"
      ],
      "result_status_next": [
        "經提案說明、機關報告及朝野立委進行詢答後，會議主席裁示本討論事項下所有相關修正草案均另定期繼續審查。",
        "考量議題複雜性與社會關注度，並參酌多位委員的程序發言與會議詢問意見，主席表示將擇期安排公聽會，針對公務人員退休資遣撫卹法相關修正草案進行更深入的討論與意見徵詢（註：民進黨籍召委鍾佳濱已排定下週一舉行一場公聽會）。"
      ]
    }
  ]
}
\`\`\`
--- 範例結束 ---
`;

  return `
${fewShotExample}

**現在，請你扮演一個立法院議事記錄的專業分析師。你的任務是閱讀以下「實際的」 ${contextHint} 議事記錄文本，並根據內容，以 **台灣繁體中文** 提取並組織資訊，生成一份**風格與詳細程度類似上述範例、易於一般民眾理解**的分析報告。模型將會以預先定義好的 JSON 結構回應。**

${truncationWarning}

**議事記錄文本內容（實際）：**
\`\`\`text
${textContent}
\`\`\`

**分析指示 (請參照上述範例的詳細程度和風格，力求內容詳實、脈絡清晰，以利民眾理解)：**
1.  **summary_title：** 用一句話清晰地總結這次會議或記錄的核心主題 (50字以內)。
2.  **overall_summary_sentence：** 用一段**內容豐富、信息量足**的話 (約100-200字，可根據內容調整) 概括整份議事記錄的主要內容、重要討論點、流程和最終的重要結論或後續方向。
3.  **committee_name：** 準確提取本次會議所屬的委員會名稱。如果文本中未明確提及或無法判斷，則讓模型將其設為 null。
4.  **agenda_items：** 識別並**詳細列出**文本中的主要議程項目。
    *   對於每個議程項目，請提供：
        *   **item_title：** 本次議程項目的完整標題或案由。
        *   **core_issue：** **詳細且深入地**概括本議程項目的核心問題、討論的背景、主要內容和涉及的關鍵面向。**如果有多個核心議題點，請用換行符 '\\n' 分隔它們於單一字串中，並確保每個點的論述都足夠清晰和完整，能夠反映討論的深度，避免過於簡略的概括。請確保每個點都是一個完整的句子或段落，避免使用 ... 結尾。**
        *   **controversy：** **詳細描述**本議程項目中的主要爭議點、不同意見的**具體內容和理由**。如果沒有明顯爭議則讓模型將其設為 null。**若有多個爭議面向，也請用換行符 '\\n' 分隔，並對每個爭議點進行充分說明。請確保每個點都是一個完整的句子或段落，避免使用 ... 結尾。**
        *   **key_speakers：** 列出在該議程項目中有**重要或代表性觀點陳述**的主要發言者及其觀點。
            *   **speaker_name：** 發言者的完整姓名及職稱 (如果文本中提供)。
            *   **speaker_viewpoint：** **盡可能完整且準確地**概括該發言者的主要觀點、論據和提出的具體建議或理由。**如果發言者提出了多個相關的論點，請用換行符 '\\n' 分隔。請確保每個觀點的陳述都是清晰、完整且能夠反映其發言的實質內容，避免使用 ... 結尾。**
        *   **result_status_next：** **詳細說明**議程項目結束後的處理結果（例如：表決票數、通過的具體決議內容、交付協商的理由、保留的項目等）以及明確的下一步行動或時程安排。**若有多個結果或後續步驟，也請用換行符 '\\n' 分隔。請使用完整的句子說明，避免使用 ... 結尾。**

**重要輸出要求：**
1.  **語言：** 所有分析內容必須使用 **台灣繁體中文**。
2.  **內容來源：** 所有分析結果都必須嚴格基於提供的「議事記錄文本內容（實際）」，力求準確反映原文。
3.  **客觀性與詳細性：** 分析應保持客觀中立，同時要**追求內容的詳細和全面（類似範例的風格）**，讓不熟悉背景的民眾也能理解會議的實質內容。
4.  **完整性：** **再次強調，請確保所有輸出的字串值都是完整且語意清晰的，絕不要在任何字串的結尾使用不完整的三個點 (...) 或其他表示內容未完成的符號。**

請開始分析實際的議事記錄文本內容。模型將會嚴格按照預設的 JSON 結構輸出結果。
`;
}

// --- 精簡分析 Prompt (保持對精簡的要求，但同樣強調結尾完整性) ---
// 這個 Prompt 通常用於重試，可能不需要太長的 Few-shot 範例，
// 但也可以考慮加入一個非常簡短的、風格一致的 Few-shot 範例。
// 為了保持這個 Prompt 的精簡性，我暫時不在此處加入長的 Few-shot 範例。
export function getShortenedAnalysisPrompt(
  categoryCode: number | null,
  textContent: string,
  isTruncated: boolean,
  previousErrorHint: string // 關於前一次失敗原因的提示
): string {
  let contextHint = "";
  if (categoryCode === 1) contextHint = "此內容來自立法院院會記錄。";
  else if (categoryCode === 2) contextHint = "此內容來自立法院委員會記錄。";
  else if (categoryCode === 3) contextHint = "此內容來自立法院黨團協商記錄。";

  const truncationWarning = isTruncated
    ? "\n**重要提示：由於原始文本過長，以下提供的內容可能已被截斷。請基於現有內容進行分析。**\n"
    : "";

  return `
請你扮演一個立法院議事記錄的專業分析師。之前的分析嘗試可能因為輸出過長或其他原因失敗 (提示: ${previousErrorHint})。現在請你閱讀以下 ${contextHint} 的議事記錄文本，並以 **更精簡扼要但仍需清晰完整** 的方式，再次以 **台灣繁體中文** 提取並組織資訊。模型將會以預先定義好的 JSON 結構回應。

${truncationWarning}

**議事記錄文本內容：**
\`\`\`text
${textContent}
\`\`\`

**分析指示 (請盡量精簡，但確保核心信息完整)：**
1.  **summary_title：** 【精簡】一句話總結核心主題 (盡量少於40字)。
2.  **overall_summary_sentence：** 【精簡】一段話概括主要內容和結論 (盡量少於100字)。
3.  **committee_name：** 提取委員會名稱。
4.  **agenda_items：** 識別並列出主要議程項目。
    *   對於每個議程項目 (請精簡)：
        *   **item_title：** 標題或案由。
        *   **core_issue：** 【精簡】核心問題。**若有多點，用 '\\n' 分隔。每個點仍需語義完整，避免 ... 結尾。**
        *   **controversy：** 【精簡】主要爭議點。**若有多點，用 '\\n' 分隔。每個點仍需語義完整，避免 ... 結尾。**
        *   **key_speakers：** 主要發言者及其觀點。
            *   **speaker_name：** 發言者。
            *   **speaker_viewpoint：** 【精簡】主要觀點。**若有多點，用 '\\n' 分隔。每個觀點仍需語義完整，避免 ... 結尾。**
        *   **result_status_next：** 【精簡】處理結果或下一步。**若有多點，用 '\\n' 分隔。每個結果仍需語義完整，避免 ... 結尾。**

**重要輸出要求：**
1.  **語言：** **台灣繁體中文**。
2.  **精簡性與清晰性：** 內容盡可能精簡，但必須傳達核心信息且語義清晰。
3.  **內容來源：** 基於提供的文本。
4.  **客觀性：** 保持客觀。
5.  **完整性 (重要)：** **即使要求精簡，所有字串值仍需語意完整，絕不要用 ... 結尾。**

請開始分析。模型將會嚴格按照預設的 JSON 結構輸出結果。
`;
}
