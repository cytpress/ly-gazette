// supabase/functions/_shared/prompts.ts

// --- 輔助函數：生成委員會提示 ---
function getCommitteeHint(categoryCode: number | null | undefined): string {
  let hint = "";
  if (categoryCode === 1 || categoryCode === 2 || categoryCode === 4 || categoryCode === 5) {
    hint = `\n*   **關於 "committee_name"**: 由於類別代碼為 ${categoryCode}，這通常發生在「立法院院會」。請在文本中確認，如果符合，請將 "committee_name" 設為 "立法院院會"。如果文本內容特別指向某委員會(較少見)，則以文本為主。`;
  } else if (categoryCode === 3) {
    hint =
      '\n*   **關於 "committee_name"**: 由於類別代碼為 3，這代表某個「委員會」。請從以下 12 個常設委員會名稱中，根據文本內容判斷並選擇最符合的一個填入 "committee_name" 欄位：\n    *   內政委員會\n    *   外交及國防委員會\n    *   經濟委員會\n    *   財政委員會\n    *   教育及文化委員會\n    *   交通委員會\n    *   司法及法制委員會\n    *   社會福利及衛生環境委員會\n    *   程序委員會\n    *   紀律委員會\n    *   經費稽核委員會\n    *   修憲委員會\n    如果文本中提及多個委員會聯席會議，請選擇主導或首次提及的委員會。如果無法從文本明確判斷是哪一個委員會，請設為 null。';
  } else if (categoryCode === 8) {
    hint = '\n*   **關於 "committee_name"**: 由於類別代碼為 8 (黨團協商)，通常不歸屬於單一委員會，請將 "committee_name" 設為 "黨團協商"。';
  } else if (categoryCode === 9) {
    hint = '\n*   **關於 "committee_name"**: 由於類別代碼為 9，這類內容較為特殊 (如總統令、咨文等)，可能與院會或特定委員會直接相關性不明確。請優先嘗試從文本內容判斷是否能歸屬到 "立法院院會" 或上述 12 個委員會之一。如果無法明確歸屬，請將 "committee_name" 設為 "其他"。';
  } else {
    hint = '\n*   **關於 "committee_name"**: 根據類別代碼，此記錄類型通常不直接對應單一委員會、院會或特定分類，請將 "committee_name" 設為 null。';
  }
  return hint;
}

// --- 常規分析 Prompt (getAnalysisPrompt) ---
export function getAnalysisPrompt(
  categoryCode: number | null | undefined,
  content: string,
  truncated: boolean = false
): string {
  const truncatedMessage = truncated
    ? "\n\n[重要提示：由於原始輸入文本過長，本處提供的文本內容是經過截斷的版本。請基於此截斷後的文本進行分析，分析結果可能無法涵蓋原始文本的全部信息。]"
    : "";
  const committeeHint = getCommitteeHint(categoryCode);

  const jsonSyntaxEmphasis = `
**JSON 語法絕對正確性要求 (JSON Syntax Absolute Correctness Requirements)**:
*   **根結構 (Root Structure)**: 最終輸出必須是一個單一的、合法的 JSON 物件。
*   **鍵名 (Keys)**: 所有的物件鍵名 (property names) 都必須用雙引號 (") 嚴格包裹。
*   **字串值 (String Values)**: 所有的字串類型的值都必須用雙引號 (") 嚴格包裹。
*   **數組元素分隔 (Array Element Separation)**: 陣列 (array, 用方括號 [] 包裹) 中的元素之間必須用逗號 (,) 分隔。最後一個元素之後不能有逗號。
*   **物件屬性分隔 (Object Property Separation)**: 物件 (object, 用大括號 {} 包裹) 中的 "鍵:值" 對 (property:value pairs) 之間必須用逗號 (,) 分隔。最後一個屬性之後不能有逗號。
*   **括號匹配 (Bracket Matching)**: 所有的大括號 {} 和方括號 [] 都必須正確配對並閉合。
*   **特殊字符轉義 (Special Character Escaping)**: 如果字串值中包含雙引號 (")、反斜線 (\\) 或其他 JSON 控制字符 (如換行符 \\n, 定位符 \\t 等)，它們必須被正確轉義 (例如，字串中的雙引號應寫為 \\"，反斜線應寫為 \\\\)。
*   **禁止註解 (No Comments)**: 標準 JSON 格式不允許任何形式的註解。
*   **最終自我檢查 (Final Self-Check)**: 在完成並輸出 JSON 物件之前，請務必在內部模擬一次解析過程，仔細檢查並確認：
    1.  所有結構（物件和數組）都已正確閉合。
    2.  所有必要的逗號都已正確添加（元素/屬性之間），且沒有多餘的尾隨逗號。
    3.  所有鍵名和字串值都已用雙引號包裹。`;

  const prompt = `
你是一位極其注重細節、追求高度準確性的國會記錄分析專家。你的核心任務是仔細審閱下方提供的立法院會議記錄文本，並嚴格遵循以下指示，以一個**語法絕對正確、結構完全符合定義、且內容詳實**的 JSON 物件格式輸出你的分析結果。

**一、 JSON 輸出結構定義 (必須完全精確匹配，不多也不少任何字段):**
\`\`\`json
{
  "summary_title": "string",
  "overall_summary_sentence": "string",
  "committee_name": "string | null",
  "agenda_items": [
    {
      "item_title": "string",
      "core_issue": "string | string[]",
      "key_speakers": [
        {
          "speaker_name": "string",
          "speaker_viewpoint": "string | string[]"
        }
      ] | null,
      "controversy": "string | string[] | null",
      "result_status_next": "string | string[]"
    }
  ]
}
\`\`\`

${jsonSyntaxEmphasis}

**二、 JSON 欄位內容要求與詳細指引:**

*   **強制性數值格式規則**: 為了公民易讀性與資料一致性，所有在摘要中提及的數值，**必須且只能使用阿拉伯數字**。**嚴禁使用**中文數字（如：一、二、三、十、百、千、萬、分之）。
    *   **範例**:
        *   法條條號："第 35 條" (不是 "第三十五條")
        *   議程編號："討論事項第 11 案" (不是 "討論事項第十一案")
        *   年份："113 年" (不是 "一百十三年")
        *   百分比："45%" (不是 "百分之四十五")
        *   分數："2/3" (不是 "三分之二")
        *   數量/基數："15 個基數" (不是 "十五個基數")
        *   金額："50 億 4,750 萬元" (可包含單位，但數字部分用阿拉伯數字)
*   **"summary_title" (字串)**: 為整個會議記錄提供一個**簡潔、精確且高度概括性**的標題。標題應能反映會議最重要的核心內容。
*   **"overall_summary_sentence" (字串)**: **必須**提供一個位於摘要開頭的總結性語句。此語句應**清晰且詳盡地列出**本次會議記錄所涵蓋的主要議程、核心討論主題或關鍵法案（請使用法案全名）。目標是讓此句能獨立且充分地概括會議的核心內容，具備足夠的資訊密度。
*   **"committee_name" (字串 或 null)**:
    *   請根據**文本內容**和**下方提供的額外提示**來判斷。${committeeHint}
    *   最終輸出的值應為 15 種可能性之一：(12 個常設委員會名稱 "內政委員會", "外交及國防委員會", "經濟委員會", "財政委員會", "教育及文化委員會", "交通委員會", "司法及法制委員會", "社會福利及衛生環境委員會", "程序委員會", "紀律委員會", "經費稽核委員會", "修憲委員會")、"立法院院會"、"黨團協商"、"其他"，或者在無法從文本明確判斷或不適用時為 **null**。
*   **"agenda_items" (物件陣列)**: 包含記錄中按順序出現的**所有**主要議程項目或法案。每個項目都是一個獨立的物件。**如果文本中沒有明確的議程項目，但有實質性討論，也請嘗試將其組織成一個或多個 agenda_item。**
  *   **"item_title" (字串)**: 該議程項目的**核心法案名稱與議程編號**。**必須省略**提案委員的姓名列表，僅保留法案的關鍵名稱。請務必在結尾處參考原始文本加入如 '(三讀)'、'(二讀)' 或 '(討論事項第 X 案)' 等輔助資訊，以確保標題簡潔且具備足夠的描述性和上下文脈絡。
  *   **"core_issue" (字串 或 字串陣列)**: **精確、具體且深入地摘要**此議題/法案的核心目標、主要內容以及提出的背景或要解決的關鍵問題。摘要應內容充實，幫助公民充分理解該議題的實質。
      *   若議題只涉及單一核心目標或內容，則此欄位為一個包含該摘要的字串 (純文字)。
      *   若議題涵蓋多個獨立、清晰可分的子議題、修正要點或面向（例如一次處理多個不同條文或多個相關但獨立的議題），則此欄位**必須是一個字串陣列**，每個字串代表一個獨立的子議題或要點摘要 (純文字陣列)。**陣列中的字串不應包含 Markdown 列表符號或其他非文本格式。請確保數組的每個元素都是一個完整的字串，並且元素之間用逗號分隔，數組以 \`]\` 正確結束。**
  *   **"key_speakers" (物件陣列 或 null)**: 包含本次討論中**最具代表性、影響力或能清晰闡述不同立場的幾位發言者**。若無關鍵發言可摘要，或發言內容過於程序性，則此欄位值**必須設為 "null"** (小寫的 null，不是字串 "null")。
      *   **"speaker_name" (字串)**: 發言者的姓名及職稱/單位。
          *   **格式要求**: 如果發言者是立法委員，請使用「**姓名 立法委員**」的格式（例如：「韓國瑜 立法委員」）。
          *   **政黨資訊**: **絕對不要**在此欄位包含發言者的政黨資訊。
          *   政府官員格式：「姓名 職稱」（例如：「陳建仁 行政院院長」）。
          *   若文本僅提及姓氏和職稱，盡可能推斷全名；無法推斷則使用「姓氏 職稱」。
      *   **"speaker_viewpoint" (字串 或 字串陣列)**: 該發言者最核心的觀點、主要訴求、提出的理由或重要的政策回應之摘要。**摘要應具體、詳盡，捕捉發言的關鍵論證點和實質內容。**
          *   若發言者只有單一核心觀點，則此欄位為一個包含該觀點的字串 (純文字)。
          *   若發言者提出多個獨立的理由、訴求或要點，則此欄位**必須是一個字串陣列**，每個字串代表一個獨立的點 (純文字陣列)。**建議在陣列的每個字串開頭加入如 '論點：'、'主要訴求：'、'反對理由：' 等結構性標示文字（這些標示文字需包含在字串值內，例如："論點：現行法規已足夠應對..."），以增強結構清晰度。陣列中的字串不應包含 Markdown 列表符號。請確保數組的每個元素都是一個完整的字串，並且元素之間用逗號分隔，數組以 \`]\` 正確結束。**
  *   **"controversy" (字串 或 字串陣列 或 null)**: 主要爭議點、攻防焦點或不同立場的摘要。**摘要應清晰點明爭議的核心議題，並客觀呈現不同方的主要論點或立場，提供足夠的細節以理解爭議全貌。**
      *   若只有單一爭議點或可總結性描述，則此欄位為一個包含該描述的字串 (純文字)。
      *   若存在多個明確的爭議點或不同立場的論點，則此欄位**必須是一個字串陣列**，每個字串代表一個獨立的爭議點或論點 (純文字陣列)。**陣列中的字串不應包含如『爭議：』等前綴文字或 Markdown 列表符號。請確保數組的每個元素都是一個完整的字串，並且元素之間用逗號分隔，數組以 \`]\` 正確結束。**
      *   若文本中無明顯實質性爭議（例如僅為程序性事項或一致通過的簡單議案），**此欄位值必須設為 "null"** (小寫的 null)。
  *   **"result_status_next" (字串 或 字串陣列)**: **清晰、準確且相對完整地說明**此議程項目在本次會議中的**最終處理結果、審查進度或當前狀態。必須包含必要的程序性資訊**（如委員會審查結論、是否決議交付黨團協商、二讀或三讀通過情況、表決結果細節等），確保資訊的完整性和上下文連貫性。
      *   若結果/狀態為單一、連貫的描述，則此欄位為一個包含該描述的字串 (純文字)。
      *   若結果/狀態包含多個獨立的程序步驟、決議事項或表決結果（例如：委員會審查完竣，決議交付黨團協商；或 二讀表決通過，黨團提議續行三讀，三讀亦通過；或 多個修正動議的表決情況），則此欄位**必須是一個字串陣列**，每個字串代表一個獨立的步驟、決議或結果描述 (純文字陣列)。**陣列中的字串不應包含 Markdown 列表符號。請確保數組的每個元素都是一個完整的字串，並且元素之間用逗號分隔，數組以 \`]\` 正確結束。**
*   所有字串內容都應遵循中立、客觀、精確、易懂的原則，**同時力求內容的詳盡與結構化，提供足夠的細節讓公民充分理解。請極度注意 JSON 語法的正確性，任何一個逗號、引號或括號的錯誤都將導致輸出無效。**

**三、 語言與風格:**
*   語言清晰、精確、中立、客觀。
*   採用略為正式但公民易懂的書面語風格。
*   聚焦關鍵、實質資訊，過濾掉冗餘描述，**但應確保摘要的完整性與細節豐富度，以滿足前述對各欄位的詳細要求，並確保 JSON 結構的完整與正確。**

**四、 輸出指令:**
*   **你的輸出必須是一個單一的、完整的、語法完全正確的 JSON 物件。** 不要包含任何 JSON 區塊標記 (\`\`\`json ... \`\`\`) 之外的文字、註解、開頭問候語（如 "好的，這是一份..."）或結尾語。
*   **在輸出前，請模擬一次 JSON 解析過程，確保所有結構都已正確閉合，所有必要的逗號都已添加，所有引號都已正確使用。**
*   如果原始文本內容**僅為簡單的程序宣告或無實質性討論**（例如僅宣讀議事錄、報告出席人數等），請直接輸出以下固定 JSON 物件：
  \`\`\`json
  {
    "summary_title": "程序性內容",
    "overall_summary_sentence": "本次記錄主要為程序性內容，無實質討論摘要。",
    "committee_name": null,
    "agenda_items": []
  }
  \`\`\`

文本內容：
"""
${content}${truncatedMessage}
"""
`;
  return prompt;
}

// --- 精簡版/補救分析 Prompt (getShortenedAnalysisPrompt) ---
export function getShortenedAnalysisPrompt(
  categoryCode: number | null | undefined,
  content: string,
  truncated: boolean = false,
  originalError?: string // 允許傳入原始錯誤信息作為參考
): string {
  const truncatedMessage = truncated
    ? "\n\n[重要提示：由於原始輸入文本過長，本處提供的文本內容是經過截斷的版本。請基於此截斷後的文本進行分析，分析結果可能無法涵蓋原始文本的全部信息。]"
    : "";
  const committeeHint = getCommitteeHint(categoryCode);
  const errorHint = originalError ? `\n\n[先前分析提示：上一次嘗試分析此文本時遇到了問題 (錯誤信息：${originalError})。本次分析的核心目標是生成一個結構完整且語法絕對正確的 JSON。內容可以進行大幅度的精簡，但 JSON 結構和語法不容許任何錯誤。]` : "";

  const simplificationEmphasis = `
**JSON 語法及內容精簡核心規則 (JSON Syntax and Content Simplification Core Rules)**:
1.  **JSON 語法絕對正確優先 (JSON Syntax Absolute Correctness First)**: 這是最高指令。所有括號 {} []、雙引號 ""、逗號 , 必須完全符合 JSON 規範。數組元素間用逗號（最後一個元素後無逗號），對象屬性間用逗號（最後一個屬性後無逗號）。鍵名和字串值必須用雙引號包裹。
2.  **極度精簡文本內容 (Extreme Content Simplification)**: 為了確保輸出成功且結構完整，請對以下所有文本字段進行最大程度的精簡，只保留最核心的關鍵詞或短語，嚴格控制長度：
    *   **"overall_summary_sentence"**: **嚴格限制在 1 句話，不超過 60 個漢字**，僅點明本次會議記錄最核心的 1-2 個主題。
    *   **"item_title"**: 保持極簡，僅包含法案最核心的名稱和議程階段標識（如三讀）。
    *   **"core_issue"**: 如果是陣列，每個子議題摘要**嚴格不超過 20 個漢字**；如果是單一字串，**嚴格不超過 50 個漢字**。僅描述最核心的變革或目的。
    *   **"key_speakers" -> "speaker_viewpoint"**: 對於每位發言者，**只提取其 1 個最簡短、最核心的觀點，該觀點摘要嚴格不超過 30 個漢字**。如果無法精簡到此程度，或者沒有特別突出且簡短的觀點，可以考慮將該 "speaker_viewpoint" 欄位設為 "null"，或者在 "key_speakers" 數組中完全省略該發言者條目以節省空間並確保結構正確。
    *   **"controversy"**: 如果是陣列，每個爭議點摘要**嚴格不超過 25 個漢字**；如果是單一字串，**嚴格不超過 60 個漢字**。僅點出最主要的分歧。若無明顯或無法簡短概括的爭議，則設為 "null"。
    *   **"result_status_next"**: 如果是陣列，每個步驟描述**嚴格不超過 25 個漢字**；如果是單一字串，**嚴格不超過 60 個漢字**。僅說明最終的處理結果或下一個最關鍵的程序狀態。
3.  **結構完整性優先 (Structural Integrity First)**: 即使內容被極度精簡，JSON 結構本身（所有在定義中出現的鍵，以及數組/對象的正確格式）必須保持完整。如果某個可為 "null" 的字段（如 "key_speakers" 或 "controversy"）因精簡後確實無有效內容可填，則將其值明確設為 "null" (小寫的 null，不是字串 "null")。

**請牢記：本次任務的最高優先級是生成一個 100% 語法正確且可被解析的 JSON。內容的詳盡程度是次要的。**`;

  const prompt = `
你是一位專注於生成語法完美 JSON 的 AI 分析員。你的首要任務是閱讀以下文本，並嚴格按照指定的 JSON 結構，輸出一個**語法絕對正確、100% 可解析、且結構完整**的 JSON 物件。${errorHint}

**一、 JSON 輸出結構要求 (必須完全符合，優先保證結構和語法正確):**
\`\`\`json
{
  "summary_title": "string", // 簡短標題
  "overall_summary_sentence": "string", // 極度精簡，1句話，不超過60字
  "committee_name": "string | null",
  "agenda_items": [
    {
      "item_title": "string", // 簡短
      "core_issue": "string | string[]", // 極度精簡，數組每項最多20字，單串最多50字
      "key_speakers": [
        {
          "speaker_name": "string",
          "speaker_viewpoint": "string | string[]" // 1個核心觀點，極度精簡，最多30字，否則設為null或省略此發言者
        }
      ] | null,
      "controversy": "string | string[] | null", // 極度精簡，數組每項最多25字，單串最多60字，無則null
      "result_status_next": "string | string[]" // 極度精簡，數組每項最多25字，單串最多60字
    }
  ]
}
\`\`\`

${simplificationEmphasis}

**二、 JSON 欄位內容指引 (嚴格遵循上述精簡規則):**

*   **強制性數值格式規則**: (同常規 Prompt，所有數值使用阿拉伯數字)
*   **"summary_title"**: 提供最簡潔的概括性標題。
*   **"overall_summary_sentence"**: **嚴格限制在 1 句話，不超過 60 個漢字**，僅點明本次會議記錄最重要的 1-2 個主題。
*   **"committee_name"**: ${committeeHint} (如果難以判斷，優先設為 "null" 以確保 JSON 輸出成功)。
*   **"agenda_items" (物件陣列)**:
  *   **"item_title" (字串)**: 僅保留核心法案名稱和議程階段標識。
  *   **"core_issue" (字串 或 字串陣列)**: **極度精簡**核心目標。如果是數組，每個子議題摘要**嚴格不超過 20 個漢字**；如果是單一字串，**嚴格不超過 50 個漢字**。
  *   **"key_speakers" (物件陣列 或 null)**:
      *   **"speaker_name" (字串)**: 「姓名 立法委員」或「姓名 職稱」。不含政黨。
      *   **"speaker_viewpoint" (字串 或 字串陣列)**: **只提取 1 個最主要、最核心的觀點，並且該觀點的摘要必須嚴格控制在 30 個漢字以內**。如果無法做到如此精簡，或者沒有一個特別突出且能簡短表達的觀點，請將此 "speaker_viewpoint" 欄位設為 "null"，或者考慮在 "key_speakers" 數組中完全省略該發言者條目。
  *   **"controversy" (字串 或 字串陣列 或 null)**: **極度精簡**主要爭議點。如果是數組，每個爭議點摘要**嚴格不超過 25 個漢字**；如果是單一字串，**嚴格不超過 60 個漢字**。如果無明顯爭議或難以簡短概括，則將此欄位值設為 "null"。
  *   **"result_status_next" (字串 或 字串陣列)**: **極度精簡**最終處理結果或下一關鍵程序狀態。如果是數組，每個步驟描述**嚴格不超過 25 個漢字**；如果是單一字串，**嚴格不超過 60 個漢字**。
*   **再次強調：JSON 語法的絕對正確性和結構完整性是本次任務的最高優先級。內容的詳細程度可以為此做出犧牲。**

**三、 輸出指令:**
*   **你的輸出必須是單一的、語法完美無誤的 JSON 物件。** 不要包含任何 JSON 區塊標記 (\`\`\`json ... \`\`\`) 之外的文字、註解、開頭問候語或結尾語。
*   **在輸出前，請在內部進行最嚴格的 JSON 語法驗證，確保每一個引號、逗號、括號都準確無誤。**
*   如果原始文本內容**僅為簡單的程序宣告或無實質性討論**（例如僅宣讀議事錄、報告出席人數等），請直接輸出以下固定 JSON 物件：
  \`\`\`json
  {
    "summary_title": "程序性內容",
    "overall_summary_sentence": "本次記錄主要為程序性內容，無實質討論摘要。",
    "committee_name": null,
    "agenda_items": []
  }
  \`\`\`

文本內容：
"""
${content}${truncatedMessage}
"""
`;
  return prompt;
}


// --- 跳過分析的條件函數 ---
export function shouldSkipAnalysis(
  categoryCode: number | null | undefined
): boolean {
  // 確保你的資料庫 CHECK 約束已更新以包含 'skipped'
  // 你可以根據需要調整跳過的 categoryCode
  return categoryCode === 6 || categoryCode === 7;
}