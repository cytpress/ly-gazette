// backend/supabase/functions/analyze-pending-agendas/prompts.ts

/**
 * Determines if analysis should be skipped. Only processes if category_code is 3.
 */
export function shouldSkipAnalysis(
  categoryCode: number | null | undefined
): boolean {
  return categoryCode !== 3;
}

/**
 * Generates the main analysis prompt for the Gemini API.
 */
export function getAnalysisPrompt(
  categoryCode: number | null | undefined,
  textContent: string
): string {
  const committeeNameInstruction = `由於類別代碼為 3，這代表某個「委員會」。請從以下12個常設委員會名稱中，根據文本內容判斷並選擇最符合的一個或多個名稱，將它們作為一個JSON字串陣列填入 "committee_name" 欄位。
  - 如果是單一委員會，陣列中只有一個元素，例如：["財政委員會"]。
  - 如果是聯席會議，請包含所有主要相關委員會的名稱，例如：["內政委員會", "司法及法制委員會"]。
  - 如果文本明確指出主導委員會，請將其放在陣列的第一個。
  - 可參考的常設委員會包含：內政委員會、外交及國防委員會、經濟委員會、財政委員會、教育及文化委員會、交通委員會、司法及法制委員會、社會福利及衛生環境委員會、程序委員會、紀律委員會、經費稽核委員會、修憲委員會。
  - 如果無法從文本明確判斷，則 "committee_name" 設為 null 或一個空陣列 []。`;

  if (categoryCode !== 3) {
    console.warn(
      `[Prompts] getAnalysisPrompt called with unexpected category_code: ${categoryCode}. This indicates a potential logic issue upstream as shouldSkipAnalysis should prevent this.`
    );
  }

  // fewShotExample is crucial for demonstrating the desired output style and conciseness.
  // This example has been revised to strictly follow the new conciseness instructions.
  const fewShotExample = `
**以下是一個分析風格和詳細程度的範例，請學習其如何組織和呈現信息（特別注意當一個欄位有多個點時，應作為 JSON 陣列中的不同字串元素）：**

**範例輸入文本（示意，非真實內容）：**
\`\`\`text
立法院財政、內政委員會第1次聯席會議紀錄
主席：羅委員明才
討論事項：審查「所得稅法第17條條文修正草案」案。第一案，黃委員國昌等提案，建議提高扣除額上限至十五萬元，並簡化稽徵程序。第二案，林委員楚茵等提案，認為應加強對離島地區的稅賦優惠。
黃委員國昌：我認為扣除額上限應提高至十五萬元，現行額度多年未調，不利育兒家庭。稽徵程序也應簡化，太擾民。
林委員楚茵：我支持簡化稽徵程序，並認為對離島的稅賦優惠應更有力道，以促進地方發展。
陳部長建仁（行政院）：提高扣除額上限至十五萬，稅損約五十億，需考量財政。稽徵程序簡化已在研議，預計下季度提出草案。離島稅賦優惠部分，現行已有相關措施，可再檢討。
主席：綜合討論，有關扣除額上限，請財政部研議。簡化稽徵程序，多數委員支持，送院會協商。離島稅賦優惠，亦請財政部納入研議。財政部就上述事項一週內提交報告。散會。
\`\`\`

**期望的範例 JSON 輸出 (風格和詳細程度示意)：**
\`\`\`json
{
  "summary_title": "所得稅法修正草案審查：聚焦扣除額、稽徵與離島稅賦",
  "overall_summary_sentence": "財政與內政委員會聯席審查所得稅法修正案，核心討論包括提高所得稅扣除額上限、簡化稽徵程序及加強離島地區稅賦優惠等議題。委員就此提出具體建議，行政部門則就財政影響及現行措施進行回應。最終多項建議交付財政部研議並要求提交報告，部分提案送院會協商。",
  "committee_name": ["財政委員會", "內政委員會"],
  "agenda_items": [
    {
      "item_title": "審查「所得稅法第17條條文修正草案」案 (含委員提案)",
      "core_issue": [
        "本次會議聚焦於所得稅法修正案中，關於個人所得稅扣除額上限的調整、現行稽徵程序的簡化，以及對離島地區稅賦優惠政策的通盤檢討。"
      ],
      "controversy": [
        "扣除額上限調整與財政平衡：黃國昌委員主張提高扣除額上限以減輕家庭負擔；行政院則強調需考量此舉可能造成的五十億元稅損及國家整體財政狀況。"
      ],
      "legislator_speakers": [
        {
          "speaker_name": "黃國昌 立法委員",
          "speaker_viewpoint": [
            "提議所得稅扣除額上限提高至十五萬元。",
            "主張簡化現行稽徵程序以提升效率。"
          ]
        },
        {
          "speaker_name": "林楚茵 立法委員",
          "speaker_viewpoint": [
            "支持簡化稽徵程序。",
            "建議加強對離島地區的稅賦優惠力道以促進地方發展。"
          ]
        }
      ],
      "respondent_speakers": [
        {
          "speaker_name": "陳建仁 行政院院長",
          "speaker_viewpoint": [
            "回應提高扣除額上限將導致顯著稅損，需審慎評估。",
            "表示稽徵程序簡化方案已在研議，預計下季度提出草案。",
            "指出離島稅賦優惠現行已有措施，可再行檢討。"
          ]
        }
      ],
      "result_status_next": [
        "財政部需研議提高扣除額上限及加強離島稅賦優惠的建議，並於一週内提交書面報告。",
        "簡化稽徵程序的相關提案，送院會協商。"
      ]
    }
  ]
}
\`\`\`
--- 範例結束 ---
`;

  return `
${fewShotExample}

**現在，請你扮演一個立法院議事記錄的專業分析師。你的任務是仔細閱讀以下「實際的」議事記錄文本，並**嚴格根據「實際文本內容」**，以 **台灣繁體中文** 「高度精煉並聚焦核心」地提取並組織資訊，生成一份分析報告。**輸出 JSON 的風格和詳細程度應盡可能接近上述範例**，目標是讓不熟悉背景的民眾也能「快速清晰」地理解會議的「實質內容和主要分歧點」。模型將會以預先定義好的 JSON 結構回應。**

**議事記錄文本內容（實際）：**
\`\`\`text
${textContent}
\`\`\`

**分析指示 (請務必基於「實際文本內容」進行分析，範例僅供風格參考。請特別注意對資訊的「篩選」與「概括」，避免簡單羅列所有細節)：**

*   **強制性數值格式規則**: 為了公民易讀性與資料一致性，所有在摘要中提及的數值，**必須且只能使用阿拉伯數字**。**嚴禁使用**中文數字。範例: "第 35 條", "討論事項第 11 案", "113 年", "45%", "2/3", "15 個基數", "50 億 4,750 萬元"。

1.  **summary_title (字串)：** 從**實際文本**中，為整個會議記錄提供一個代表全文核心焦點的高度概括性摘要標題 (50字以內)。
2.  **overall_summary_sentence (字串)：** 從**實際文本**中，提供一個概括性總結句，涵蓋主要內容、流程、法案全名或關鍵議題、以及重要結論，使讀者能快速理解會議核心 (約100-150字)。
3.  **committee_name (字串陣列 或 null)：** ${committeeNameInstruction}
4.  **agenda_items (物件陣列)：** 從**實際文本中**識別並**詳細列出「主要」議程項目**。對於每個議程項目，根據**實際文本內容**提供：
    *   **item_title (字串)：** 該議程項目的核心法案名稱與議程編號，例如 '某某法案修正草案 (討論事項第一案)'。請省略提案人姓名。
    *   **core_issue (字串陣列 或 null)：** 將該議程項目討論的「所有核心議題、主要關切點、背景及關鍵面向」，「高度概括並綜合提煉」成「最多兩句」能涵蓋整體討論焦點的描述性語句。應著重於議題的「實質內容和主題方向」，避免僅列舉細項或程序性描述。如果確實存在多個「重大且獨立」的議題方向（例如討論完一個法案後接著討論另一個完全不同的法案），才可作為陣列中的不同元素（總數不宜超過二個主要方向），但每個元素仍需是高度概括性的。無明確核心議題則設為 null。
    *   **controversy (字串陣列 或 null)：** 務必清晰且具體地描述該議程項目「最主要」的「至多7個」關鍵爭議點。對於每個爭議點，應明確呈現至少兩方（或多方）的「核心」不同觀點、論點或具體行為差異，並「簡述其主要理由」。**嚴格篩選，避免列出超過7個以上的爭議點，即使文本中提及多個潛在分歧。僅選擇那些對議案走向或政策辯論具有實質影響的、最突出的分歧點。** 無明顯重大爭議則為 null。
    *   **legislator_speakers (物件陣列 或 null)：** 列出在該議程項目中「具代表性或影響力」的「立法委員」。
        *   **speaker_name (字串)：** 務必統一格式為「姓名（全名）空格 立法委員」。請勿包含黨籍資訊。
        *   **speaker_viewpoint (字串陣列 或 null)：** **高度精煉並直接陳述**該立法委員針對「當前議程項目或法案」提出的「至多5個最核心的論點、具體主張、關鍵理由或明確建議」。**「嚴格篩選」，避免羅列所有發言細節、重複性提問或僅表達一般性關切（例如：僅「關心進度」、「詢問細節」而未提出實質主張者，除非該詢問本身揭示了重大問題）。直接點出其實質觀點。** 若有多個獨立且「關鍵」的實質觀點（總數不宜超過5個），作為陣列元素。完全排除純粹的程序性發言或無實質內容的寒暄附和。
    *   **respondent_speakers (物件陣列 或 null)：** 列出在該議程項目中「最主要回應或報告」的「政府官員」或「相關事業單位代表」。
        *   **speaker_name (字串)：** **務必統一格式為「姓名（全名）空格 完整職稱空格 所屬單位（若與職稱不同時需列出，若職稱已包含單位則可省略重複單位）」**，例如：「陳建仁 行政院院長」、「王美花 經濟部部長」、「李世強 中科院院長」。**應優先提取「姓名」，然後是「職稱」，最後是「單位」。如果文本中出現如「陳部長建仁」或「李院長世強」，請調整為「陳建仁 部長」或「李世強 院長」並附上單位。**
        *   **speaker_viewpoint (字串陣列 或 null)：** **高度精煉並直接陳述**該答詢者針對質詢的「至多10個最核心的政策回應、明確說明、關鍵數據提供、官方立場或承諾」。**「嚴格篩選」，避免羅列所有答覆細節或重複性澄清。直接點出其實質答覆內容。** 若有多個獨立且「關鍵」的實質答覆點（總數不宜超過10個），作為陣列元素。完全排除純粹的程序性發言。
    *   **result_status_next (字串陣列 或 null)：** 清晰且相對完整地說明關於此議程的「具有實質意義的最終處理結果、審查進度或明確的下一步行動」。
        **請專注於以下類型的實質內容：**
        1.  **法案/議案的具體處置：** 例如，「法案三讀通過」、「修正案送院會協商」、「全案保留，送院會處理」、「併案審查後，提報院會討論，院會討論前須交由黨團協商」。
        2.  **具體的交付事項或要求：** 例如，「請相關部會於一週內以書面答復」、「要求財政部研議...並於一週內提交書面報告」、「委員所提書面質詢列入紀錄，刊登公報，並請金融監督管理委員會以書面答復」。
        3.  **重大的決議或共識：** 例如，「多項預算提案經討論後部分凍結共計XX元」、「就某某議題達成初步共識，將成立專案小組持續追蹤」。
        4.  **明確的後續步驟：** 例如，「下次會議將繼續討論此案」、「將擇期再審」。
        **務必排除以下與議案實質進展無關的程序性描述：**
        例如：「報告及詢答完畢」、「相關人員可先行離席」、「宣讀完畢」、「繼續討論下一案」、「某委員提案不處理/撤案」、「議事錄確定」、「散會」、「今日登記發言委員均已詢答完畢」等等。
        **如果沒有明確的實質結果或下一步行動，則此欄位應設為 null 或空陣列 []。**
        若有多個獨立的實質結果或行動（總數不宜超過5個關鍵點），作為陣列元素。

**重要輸出要求：**
1.  **語言：** **台灣繁體中文**。
2.  **內容來源：** **所有分析結果必須嚴格基於提供的「實際議事記錄文本內容」，絕不能使用範例文字，力求準確。**
3.  **客觀性與詳細性：** 分析應客觀中立，**追求「核心資訊」的詳細和全面，而非所有細節的堆砌。**
4.  **JSON 結構與內容完整性：** **模型必須嚴格遵循預設的 JSON 結構輸出。所有輸出的字串值都必須是完整且語意清晰的。"committee_name" 若無信息，應為 null 或空陣列。"legislator_speakers" 和 "respondent_speakers" 若無相關發言者，應為 null 或空陣列。**
5.  **忽略圖片標記：** **完全忽略所有類似 "[image: imageXXX.jpg]" 格式的圖片佔位符。**
6.  **欄位值為 null/空陣列：** 若無信息或不適用，可為 null 的欄位請明確設為 JSON 的 null。對於 "committee_name"、"legislator_speakers"、"respondent_speakers" 等陣列類型欄位，若無適用內容，可以是 null 或空陣列 []。
7.  **處理程序性內容：** 若文本**僅為簡單程序宣告或無實質討論**，輸出固定 JSON：
    \`\`\`json
    {
      "summary_title": "程序性內容",
      "overall_summary_sentence": "本次記錄主要為程序性內容，無實質討論摘要。",
      "committee_name": null,
      "agenda_items": []
    }
    \`\`\`

請開始分析「實際的」議事記錄文本內容。
`;
}
