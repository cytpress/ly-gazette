// backend/supabase/functions/analyze-pending-agendas/prompts.ts

/**
 * Determines if analysis should be skipped. Only processes if category_code is 3.
 */
export function shouldSkipAnalysis(
  categoryCode: number | null | undefined
): boolean {
  return categoryCode !== 3;
}

/**
 * Generates the main analysis prompt for the Gemini API.
 */
export function getAnalysisPrompt(
  categoryCode: number | null | undefined,
  textContent: string,
): string {
  const committeeNameInstruction = `由於類別代碼為 3，這代表某個「委員會」。請從以下12個常設委員會名稱中，根據文本內容判斷並選擇最符合的一個或多個名稱，將它們作為一個JSON字串陣列填入 "committee_name" 欄位。
  - 如果是單一委員會，陣列中只有一個元素，例如：["財政委員會"]。
  - 如果是聯席會議，請包含所有主要相關委員會的名稱，例如：["內政委員會", "司法及法制委員會"]。
  - 如果文本明確指出主導委員會，請將其放在陣列的第一個。
  - 可參考的常設委員會包含：內政委員會、外交及國防委員會、經濟委員會、財政委員會、教育及文化委員會、交通委員會、司法及法制委員會、社會福利及衛生環境委員會、程序委員會、紀律委員會、經費稽核委員會、修憲委員會。
  - 如果無法從文本明確判斷，則 "committee_name" 設為 null 或一個空陣列 []。`;

  if (categoryCode !== 3) {
    console.warn(
      `[Prompts] getAnalysisPrompt called with unexpected category_code: ${categoryCode}. This indicates a potential logic issue upstream as shouldSkipAnalysis should prevent this.`
    );
  }

  // fewShotExample is crucial for demonstrating the desired output style and conciseness.
  // Ensure this example strictly follows ALL instructions below, especially for
  // controversy, speaker_viewpoint (concise, direct points), core_issue (summarized),
  // and result_status_next (filtered for substantive outcomes).
  const fewShotExample = `
**以下是一個分析風格和詳細程度的範例，請學習其如何組織和呈現信息（特別注意當一個欄位有多個點時，應作為 JSON 陣列中的不同字串元素）：**

**範例輸入文本（示意，非真實內容）：**
\`\`\`text
立法院財政、內政委員會第1次聯席會議紀錄
主席：羅委員明才
討論事項：審查「所得稅法第17條條文修正草案」案。第一案，黃委員國昌等提案，建議提高扣除額上限至十五萬元...。第二案，林委員楚茵等提案，建議簡化稽徵程序...。
黃委員國昌：我認為扣除額上限應提高至十五萬元，現行額度多年未調，不利育兒家庭。稽徵程序也應簡化，太擾民。
陳部長建仁（行政院）：提高扣除額上限至十五萬，稅損約五十億，需考量財政。稽徵程序簡化已在研議。
主席：第一案，黃委員提案，保留。第二案，林委員提案，送院會協商。另請財政部就扣除額問題研議，一週內提交報告。有關稽徵程序簡化，請相關單位加速。散會。
\`\`\`

**期望的範例 JSON 輸出 (風格和詳細程度示意，直接輸出陣列，並已忽略圖片標記)：**
\`\`\`json
{
  "summary_title": "所得稅法修正草案審查：聚焦扣除額上限與稽徵程序簡化",
  "overall_summary_sentence": "財政與內政委員會聯席審查所得稅法修正案，重點討論提高扣除額上限的提案（由黃國昌委員提出，主張額度未調且應減輕家庭負擔）與簡化稽徵程序的建議。行政院陳建仁部長回應需考量財政平衡及稅損，並表示簡化程序已在研議。最終，提高扣除額上限提案保留，簡化稽徵程序提案送院會協商，主席並裁示財政部研議扣除額問題。",
  "committee_name": ["財政委員會", "內政委員會"],
  "agenda_items": [
    {
      "item_title": "審查「所得稅法第17條條文修正草案」案 (含委員提案)",
      "core_issue": [
        "討論所得稅法修正草案中，關於扣除額上限應否提高以及現行稽徵程序是否需要簡化等核心問題。"
      ],
      "controversy": [
        "扣除額上限調整：黃國昌委員（基於額度未調、減輕家庭負擔）主張提高至十五萬元；行政院（考量財政平衡、預估五十億稅損）則認為需審慎評估。"
      ],
      "legislator_speakers": [
        {
          "speaker_name": "黃國昌 立法委員",
          "speaker_viewpoint": [
            "提議所得稅扣除額上限提高至十五萬元。",
            "主張簡化現行稽徵程序以利民。"
          ]
        }
      ],
      "respondent_speakers": [
        {
          "speaker_name": "陳建仁 行政院院長",
          "speaker_viewpoint": [
            "說明提高扣除額上限將導致約五十億元稅損，需考量財政平衡。",
            "表示稽徵程序簡化方案已在研議中。"
          ]
        }
      ],
      "result_status_next": [
        "財政部需針對提高扣除額上限的建議進行研議，並於一週内提交書面報告。",
        "簡化稽徵程序的提案，送院會協商。",
        "提高扣除額上限的提案，狀態：保留。"
      ]
    }
  ]
}
\`\`\`
--- 範例結束 ---
`;

  return `
${fewShotExample}

**現在，請你扮演一個立法院議事記錄的專業分析師。你的任務是仔細閱讀以下「實際的」議事記錄文本，並**嚴格根據「實際文本內容」**，以 **台灣繁體中文** 「高度精煉並聚焦核心」地提取並組織資訊，生成一份分析報告。**輸出 JSON 的風格和詳細程度應盡可能接近上述範例**，目標是讓不熟悉背景的民眾也能「快速清晰」地理解會議的「實質內容和主要分歧點」。模型將會以預先定義好的 JSON 結構回應。**

**議事記錄文本內容（實際）：**
\`\`\`text
${textContent}
\`\`\`

**分析指示 (請務必基於「實際文本內容」進行分析，範例僅供風格參考。請特別注意對資訊的「篩選」與「概括」，避免簡單羅列所有細節)：**

*   **強制性數值格式規則**: 為了公民易讀性與資料一致性，所有在摘要中提及的數值，**必須且只能使用阿拉伯數字**。**嚴禁使用**中文數字。範例: "第 35 條", "討論事項第 11 案", "113 年", "45%", "2/3", "15 個基數", "50 億 4,750 萬元"。

1.  **summary_title (字串)：** 從**實際文本**中，為整個會議記錄提供一個代表全文核心焦點的高度概括性摘要標題 (50字以內)。
2.  **overall_summary_sentence (字串)：** 從**實際文本**中，提供一個概括性總結句，涵蓋主要內容、流程、法案全名或關鍵議題、以及重要結論，使讀者能快速理解會議核心 (約100-150字)。
3.  **committee_name (字串陣列 或 null)：** ${committeeNameInstruction}
4.  **agenda_items (物件陣列)：** 從**實際文本中**識別並**詳細列出「主要」議程項目**。對於每個議程項目，根據**實際文本內容**提供：
    *   **item_title (字串)：** 該議程項目的核心法案名稱與議程編號，例如 '某某法案修正草案 (討論事項第一案)'。請省略提案人姓名。
    *   **core_issue (字串陣列 或 null)：** 將該議程項目討論的核心問題、背景、主要內容和關鍵面向，綜合提煉成「一至兩句」概括性的描述。如果有多個明確且獨立的核心議題方向，可以分別作為陣列中的不同字串元素（總數不宜過多，例如最多3-4個主要方向），但應避免將細碎的子問題簡單羅列。目標是高度概括，反映討論的實質焦點。無明確核心議題則設為 null。
    *   **controversy (字串陣列 或 null)：** 務必清晰且具體地描述該議程項目「最主要」的「一至三個」關鍵爭議點。對於每個爭議點，應明確呈現至少兩方（或多方）的「核心」不同觀點、論點或具體行為差異，並「簡述其主要理由」。**避免列出超過三個以上的爭議點，即使文本中提及很多。請篩選出最具代表性和影響力的。** 若有多個獨立爭議點，作為陣列元素，確保描述清晰。無明顯重大爭議則為 null。
    *   **legislator_speakers (物件陣列 或 null)：** 列出在該議程項目中「最具代表性或影響力」的「立法委員」（通常不超過3-5位，除非發言都極其關鍵且觀點獨特）。
        *   **speaker_name (字串)：** 務必統一格式為「姓名（全名）空格 立法委員」。請勿包含黨籍資訊。
        *   **speaker_viewpoint (字串陣列 或 null)：** **高度精煉並直接陳述**該立法委員針對「當前議程項目或法案」提出的「一至三個最核心的論點、具體主張、關鍵理由或明確建議」。**「嚴格篩選」，避免羅列所有發言細節、重複性提問或僅表達一般性關切的內容。直接點出其實質觀點。** 例如，將「委員詢問預算是否足夠、執行進度如何、未來規劃為何」濃縮為「質疑預算編列不足、執行進度落後及未來規劃不明確」。若有多個獨立且「關鍵」的實質觀點（總數不宜超過三個），作為陣列元素。完全排除純粹的程序性發言或無實質內容的寒暄附和。
    *   **respondent_speakers (物件陣列 或 null)：** 列出在該議程項目中「最主要回應或報告」的「政府官員」或「相關事業單位代表」（通常不超過2-3位，除非有多方關鍵回應）。
        *   **speaker_name (字串)：** 務必統一格式為「姓名（全名）空格 完整職稱/所屬單位」。
        *   **speaker_viewpoint (字串陣列 或 null)：** **高度精煉並直接陳述**該答詢者針對質詢的「一至三個最核心的政策回應、明確說明、關鍵數據提供、官方立場或承諾」。**「嚴格篩選」，避免羅列所有答覆細節或重複性澄清。直接點出其實質答覆內容。** 例如，將「部長回應會納入考量並請相關單位研議」改為「承諾將委員意見納入後續政策評估並指示相關單位研議」。若有多個獨立且「關鍵」的實質答覆點（總數不宜超過三個），作為陣列元素。完全排除純粹的程序性發言。
    *   **result_status_next (字串陣列 或 null)：** 清晰且相對完整地說明關於此議程的「具有實質意義的最終處理結果、審查進度或明確的下一步行動」。**務必排除僅為程序性宣告（如「相關人員可先行離席」、「宣讀完畢」、「繼續討論下一案」等與議案實質進展無關的描述）或無明確決議的內容。僅記錄影響議案走向或具有約束力的決議（如預算凍刪數額與條件、法案送交何處）、交付事項、重要的保留意見及原因、或確切的後續步驟。避免逐條列舉所有提案的處理方式，盡可能總結相似的決議。** 若有多個獨立的實質結果或行動，作為陣列元素。若無明確的實質結果或下一步則設為 null。

**重要輸出要求：**
1.  **語言：** **台灣繁體中文**。
2.  **內容來源：** **所有分析結果必須嚴格基於提供的「實際議事記錄文本內容」，絕不能使用範例文字，力求準確。**
3.  **客觀性與詳細性：** 分析應客觀中立，**追求「核心資訊」的詳細和全面，而非所有細節的堆砌。**
4.  **JSON 結構與內容完整性：** **模型必須嚴格遵循預設的 JSON 結構輸出。所有輸出的字串值都必須是完整且語意清晰的。"committee_name" 若無信息，應為 null 或空陣列。"legislator_speakers" 和 "respondent_speakers" 若無相關發言者，應為 null 或空陣列。**
5.  **忽略圖片標記：** **完全忽略所有類似 "[image: imageXXX.jpg]" 格式的圖片佔位符。**
6.  **欄位值為 null/空陣列：** 若無信息或不適用，可為 null 的欄位請明確設為 JSON 的 null。對於 "committee_name"、"legislator_speakers"、"respondent_speakers" 等陣列類型欄位，若無適用內容，可以是 null 或空陣列 []。
7.  **處理程序性內容：** 若文本**僅為簡單程序宣告或無實質討論**，輸出固定 JSON：
    \`\`\`json
    {
      "summary_title": "程序性內容",
      "overall_summary_sentence": "本次記錄主要為程序性內容，無實質討論摘要。",
      "committee_name": null,
      "agenda_items": []
    }
    \`\`\`

請開始分析「實際的」議事記錄文本內容。
`;
}